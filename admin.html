<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå° - Sena's blog</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }

        /* Token è¾“å…¥åŒºåŸŸæ ·å¼ */
        .token-section { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px dashed #cbd5e0; }
        .token-section h4 { margin-top: 0; color: #2d3748; }
        .token-input-group { display: flex; gap: 10px; align-items: center; }
        #token-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }

        .post-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .edit-area { margin-top: 30px; padding-top: 20px; border-top: 2px solid #2c3e50; }
        input, textarea { width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button.delete { background: #e74c3c; margin-left: 5px; }
        .status-msg { font-size: 0.9rem; margin-top: 10px; color: #3182ce; }
    </style>
</head>
<body>
<div class="admin-container">
    <h2>åšå®¢åå°ç®¡ç†</h2>

    <div class="token-section">
        <h4>ğŸ”‘ èº«ä»½éªŒè¯ (GitHub Token)</h4>
        <div class="token-input-group">
            <input type="password" id="token-input" placeholder="ghp_xxxxxxxxxxxx">
            <button onclick="saveTokenToLocal()" style="background: #4a5568;">ä¿å­˜åˆ°æœ¬åœ°</button>
            <button onclick="clearToken()" style="background: #a0aec0;">æ¸…é™¤</button>
        </div>
        <p style="font-size: 0.8rem; color: #718096; margin-top: 5px;">Token ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ è‡³ä»£ç åº“ã€‚</p>
    </div>

<!--    <div id="admin-post-list"></div>-->
    <div class="admin-main">
        <div class="list-section">
            <h3>å·²æœ‰æ–‡ç« åˆ—è¡¨</h3>
            <div id="admin-post-list" class="scroll-window">
            </div>
        </div>

        <div class="edit-section">
        </div>
    </div>

    <div class="edit-area">
        <h3 id="form-title">æ’°å†™æ–°æ–‡ç« </h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="text" id="post-title" placeholder="æ–‡ç« æ ‡é¢˜">
        <input type="text" id="post-category" placeholder="åˆ†ç±» (å¦‚: æŠ€æœ¯, ç”Ÿæ´»)">
        <textarea id="post-content" rows="12" placeholder="å†…å®¹æ”¯æŒ Markdown æ ¼å¼..."></textarea>
        <button id="submit-btn" onclick="savePost()">ğŸš€ å‘å¸ƒå¹¶åŒæ­¥åˆ° GitHub</button>
        <button onclick="resetForm()" style="background:#95a5a6">å–æ¶ˆä¿®æ”¹</button>
        <div id="status" class="status-msg"></div>
    </div>
</div>

<script src="data.js"></script>
<script src="githubService.js"></script>
<script>
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯»å–æœ¬åœ°ä¿å­˜çš„ Token
    window.onload = () => {
        const savedToken = localStorage.getItem('my_gh_token');
        if (savedToken) {
            document.getElementById('token-input').value = savedToken;
        }
        renderAdminList();
    };

    function saveTokenToLocal() {
        const val = document.getElementById('token-input').value;
        if (val) {
            localStorage.setItem('my_gh_token', val);
            alert('Token å·²åŠ å¯†ä¿å­˜è‡³æœ¬åœ°æµè§ˆå™¨å­˜å‚¨');
        }
    }

    function clearToken() {
        localStorage.removeItem('my_gh_token');
        document.getElementById('token-input').value = '';
        alert('æœ¬åœ° Token å·²æ¸…é™¤');
    }

    function renderAdminList() {
        const listContainer = document.getElementById('admin-post-list');
        const lastScrollPos = listContainer.scrollTop; // è®°å½•ä½ç½®
        listContainer.innerHTML = window.blogPosts.map((post, index) => `
                <div class="post-item">
                    <span><strong>${post.title}</strong> <small style="color: #666">(${post.date})</small></span>
                    <div>
                        <button onclick="editPost(${index})">ç¼–è¾‘</button>
                        <button class="delete" onclick="deletePost(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        listContainer.innerHTML = html;
        listContainer.scrollTop = lastScrollPos; // æ¢å¤ä½ç½®
    }

    // ... å…¶ä½™ editPost, deletePost, resetForm é€»è¾‘ä¿æŒä¸å˜ ...
    // (çœç•¥éƒ¨åˆ†ä¸ä¹‹å‰ç›¸åŒä»¥ä¿æŒç®€æ´)

    function editPost(index) {
        const post = window.blogPosts[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('post-title').value = post.title;
        document.getElementById('post-category').value = post.category;
        document.getElementById('post-content').value = post.fullContent;
        document.getElementById('form-title').innerText = "ç¼–è¾‘æ–‡ç« ";
        window.scrollTo(0, document.body.scrollHeight);
    }

    async function savePost() {
        const token = document.getElementById('token-input').value;
        if (!token) return alert("è¯·å…ˆè¾“å…¥ GitHub Token");

        const index = parseInt(document.getElementById('edit-index').value);
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('post-content').value;
        const category = document.getElementById('post-category').value;

        if(!title || !content) return alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");

        const newPost = {
            title,
            date: new Date().toISOString().split('T')[0],
            excerpt: content.substring(0, 60).replace(/\n/g, "") + "...",
            fullContent: content,
            category: category || "æœªåˆ†ç±»"
        };

        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerText = "åŒæ­¥ä¸­...";

        if (index === -1) {
            window.blogPosts.unshift(newPost);
        } else {
            window.blogPosts[index] = newPost;
        }

        const fileContent = `window.blogPosts = ${JSON.stringify(window.blogPosts, null, 2)};`;

        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¿®æ”¹ githubService.js æ¥å— token å‚æ•°
        const success = await updateGitHubData(fileContent, token);

        if (success) {
            document.getElementById('status').innerText = "âœ… åŒæ­¥æˆåŠŸï¼GitHub æ­£åœ¨éƒ¨ç½²ï¼Œè¯·å‡ åˆ†é’Ÿååˆ·æ–°ã€‚";
            resetForm();
            renderAdminList();
        } else {
            alert("åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®æˆ–å…·æœ‰ä»“åº“å†™æƒé™ã€‚");
            // å¤±è´¥æ—¶å›æ»šæœ¬åœ°ä¿®æ”¹ï¼Œé¿å…æ•°æ®çŠ¶æ€ä¸åŒæ­¥
            location.reload();
        }
        btn.disabled = false;
        btn.innerText = "ğŸš€ å‘å¸ƒå¹¶åŒæ­¥åˆ° GitHub";
    }

    async function deletePost(index) {
        const token = document.getElementById('token-input').value;
        if (!token) return alert("è¯·å…ˆè¾“å…¥ Token æ‰èƒ½æ‰§è¡Œåˆ é™¤æ“ä½œ");

        // 1. å¼¹å‡ºç¡®è®¤æ¡†ï¼Œé˜²æ­¢è¯¯åˆ 
        if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${window.blogPosts[index].title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`)) {

            // 2. ä»æœ¬åœ°æ•°ç»„ä¸­ç§»é™¤è¯¥æ–‡ç« 
            window.blogPosts.splice(index, 1);

            // 3. æ„å»ºæ–°çš„æ–‡ä»¶å­—ç¬¦ä¸²
            const fileContent = `window.blogPosts = ${JSON.stringify(window.blogPosts, null, 2)};`;

            // 4. è°ƒç”¨åŒæ­¥å‡½æ•°æ¨é€åˆ° GitHub
            const btn = document.querySelector('.delete'); // åªæ˜¯ä¸ºäº†è§†è§‰åé¦ˆ
            console.log("æ­£åœ¨ä» GitHub åˆ é™¤æ•°æ®...");

            const success = await updateGitHubData(fileContent, token);

            if (success) {
                alert("åˆ é™¤æˆåŠŸï¼");
                renderAdminList(); // é‡æ–°æ¸²æŸ“ç®¡ç†åˆ—è¡¨
            } else {
                alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æƒé™ã€‚");
                // å»ºè®®åˆ·æ–°é¡µé¢ä»¥åŒæ­¥å›åŸå§‹æ•°æ®
                location.reload();
            }
        }
    }

    function resetForm() {
        document.getElementById('edit-index').value = "-1";
        document.getElementById('post-title').value = "";
        document.getElementById('post-category').value = "";
        document.getElementById('post-content').value = "";
        document.getElementById('form-title').innerText = "æ’°å†™æ–°æ–‡ç« ";
    }
</script>
</body>
</html>