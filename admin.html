<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå° - Sena's blog</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }

        /* Token è¾“å…¥åŒºåŸŸæ ·å¼ */
        .token-section { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px dashed #cbd5e0; }
        .token-section h4 { margin-top: 0; color: #2d3748; }
        .token-input-group { display: flex; gap: 10px; align-items: center; }
        #token-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }

        .post-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .edit-area { margin-top: 30px; padding-top: 20px; border-top: 2px solid #2c3e50; }
        input, textarea { width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button.delete { background: #e74c3c; margin-left: 5px; }
        .status-msg { font-size: 0.9rem; margin-top: 10px; color: #3182ce; }
    </style>
</head>
<body>
<div class="admin-container">
    <h2>åšå®¢åå°ç®¡ç†</h2>

    <div class="token-section">
        <h4>ğŸ”‘ èº«ä»½éªŒè¯ (GitHub Token)</h4>
        <div class="token-input-group">
            <input type="password" id="token-input" placeholder="ghp_xxxxxxxxxxxx">
            <button onclick="saveTokenToLocal()" style="background: #4a5568;">ä¿å­˜åˆ°æœ¬åœ°</button>
            <button onclick="clearToken()" style="background: #a0aec0;">æ¸…é™¤</button>
        </div>
        <p style="font-size: 0.8rem; color: #718096; margin-top: 5px;">Token ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ è‡³ä»£ç åº“ã€‚</p>
    </div>

<!--    <div id="admin-post-list"></div>-->
    <div class="admin-main">
        <div class="list-section">
            <h3>å·²æœ‰æ–‡ç« åˆ—è¡¨</h3>
            <div id="admin-post-list" class="scroll-window">
            </div>
        </div>

        <div class="edit-section">
        </div>
    </div>

    <div class="edit-area">
        <h3 id="form-title">æ’°å†™æ–°æ–‡ç« </h3>
        <input type="hidden" id="edit-index" value="-1">

        <div class="toolbar">
            <button type="button" onclick="insertFormat('bold')"><b>B</b></button>
            <button type="button" onclick="insertFormat('italic')"><i>I</i></button>

            <div class="color-dropdown">
                <button type="button">ğŸ¨ é¢œè‰² â–¼</button>
                <div class="color-menu">
                    <div class="color-option" style="background: #e74c3c" onclick="insertFormat('color', '#e74c3c')"></div>
                    <div class="color-option" style="background: #3498db" onclick="insertFormat('color', '#3498db')"></div>
                    <div class="color-option" style="background: #2ecc71" onclick="insertFormat('color', '#2ecc71')"></div>
                    <div class="color-option" style="background: #f1c40f" onclick="insertFormat('color', '#f1c40f')"></div>
                    <div class="color-option" style="background: #9b59b6" onclick="insertFormat('color', '#9b59b6')"></div>
                </div>
            </div>

            <button type="button" onclick="insertFormat('highlight')">âœ¨ å¼ºè°ƒ</button>
            <button type="button" onclick="insertFormat('image')">ğŸ–¼ å›¾ç‰‡</button>
        </div>

        <div class="editor-container">
            <div class="editor-input">
                <input type="text" id="post-title" placeholder="æ–‡ç« æ ‡é¢˜" oninput="updatePreview()">
                <input type="text" id="post-category" placeholder="åˆ†ç±»" oninput="updatePreview()">
                <textarea id="post-content" rows="15" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..." oninput="updatePreview()"></textarea>
            </div>
            <div class="editor-preview">
                <div class="preview-label">å®æ—¶é¢„è§ˆ</div>
                <div id="live-preview" class="markdown-body"></div>
            </div>
        </div>

        <button id="submit-btn" onclick="savePost()">ğŸš€ å‘å¸ƒå¹¶åŒæ­¥åˆ° GitHub</button>
        <button onclick="resetForm()" style="background:#95a5a6">å–æ¶ˆä¿®æ”¹</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</div>

<script src="data.js"></script>
<script src="githubService.js"></script>
<script>
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯»å–æœ¬åœ°ä¿å­˜çš„ Token
    window.onload = () => {
        const savedToken = localStorage.getItem('my_gh_token');
        if (savedToken) {
            document.getElementById('token-input').value = savedToken;
        }
        renderAdminList();
        initDragAndDrop();
    };

    function saveTokenToLocal() {
        const val = document.getElementById('token-input').value;
        if (val) {
            localStorage.setItem('my_gh_token', val);
            alert('Token å·²åŠ å¯†ä¿å­˜è‡³æœ¬åœ°æµè§ˆå™¨å­˜å‚¨');
        }
    }

    function clearToken() {
        localStorage.removeItem('my_gh_token');
        document.getElementById('token-input').value = '';
        alert('æœ¬åœ° Token å·²æ¸…é™¤');
    }

    function renderAdminList() {
        const listContainer = document.getElementById('admin-post-list');
        if (!listContainer) return;

        // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨æ­¤å¤„å®šä¹‰ html å˜é‡ï¼Œåˆå§‹ä¸ºç©ºå­—ç¬¦ä¸²
        let html = '';

        // 2. æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if (!window.blogPosts || window.blogPosts.length === 0) {
            listContainer.innerHTML = '<div style="padding:20px; color:#999;">æš‚æ— æ–‡ç« ï¼Œå¼€å§‹æ’°å†™ç¬¬ä¸€ç¯‡å§ï¼</div>';
            return;
        }

        // 3. éå†æ•°æ®ç”Ÿæˆ HTML å­—ç¬¦ä¸²
        window.blogPosts.forEach((post, index) => {
            html += `
            <div class="admin-item">
                <div style="display:flex; flex-direction:column; max-width:70%;">
                    <span style="font-weight:bold; color:#2c3e50;">${post.title}</span>
                    <small style="color:#999;">${post.date} | ${post.category}</small>
                </div>
                <div class="admin-btns">
                    <button onclick="editPost(${index})" style="background:#3498db; margin-right:5px;">ä¿®æ”¹</button>
                    <button onclick="deletePost(${index})" style="background:#e74c3c;">åˆ é™¤</button>
                </div>
            </div>
        `;
        });

        // 4. å°†æ‹¼æ¥å¥½çš„ HTML ä¸€æ¬¡æ€§æ¸²æŸ“åˆ°å®¹å™¨ä¸­
        listContainer.innerHTML = html;
    }
    // åœ¨ admin.html çš„ <script> é¡¶éƒ¨æ·»åŠ 
    let pendingImages = []; // ç”¨äºå­˜æ”¾å¾…ä¸Šä¼ çš„å›¾ç‰‡å¯¹è±¡ {name, base64}

    // åˆå§‹åŒ–æ‹–æ‹½äº‹ä»¶
    function initDragAndDrop() {
        const textarea = document.getElementById('post-content');

        textarea.addEventListener('dragover', (e) => {
            e.preventDefault();
            textarea.style.borderColor = '#3498db'; // æ‹–å…¥æ—¶é«˜äº®è¾¹æ¡†
        });

        textarea.addEventListener('dragleave', () => {
            textarea.style.borderColor = '#ddd';
        });

        textarea.addEventListener('drop', async (e) => {
            e.preventDefault();
            textarea.style.borderColor = '#ddd';

            const files = e.dataTransfer.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    await processImage(file);
                }
            }
        });
    }

    // å¤„ç†å›¾ç‰‡æ–‡ä»¶
    async function processImage(file) {
        const textarea = document.getElementById('post-content');
        const fileName = `img_${Date.now()}_${file.name}`; // åŠ ä¸Šæ—¶é—´æˆ³é˜²æ­¢é‡å
        const reader = new FileReader();

        reader.onload = async (e) => {
            const base64Content = e.target.result.split(',')[1]; // è·å–çº¯ base64 éƒ¨åˆ†

            // 1. è®°å½•åˆ°å¾…ä¸Šä¼ åˆ—è¡¨
            pendingImages.push({
                name: fileName,
                content: base64Content
            });

            // 2. åœ¨ç¼–è¾‘æ¡†æ’å…¥ Markdown è¯­æ³•
            // æ³¨æ„ï¼šè¿™é‡Œå…ˆç”¨ Base64 æ¸²æŸ“ä»¥å®ç°â€œå³æ—¶é¢„è§ˆâ€ï¼Œä¿å­˜æ—¶ä¼šè¢«æ›¿æ¢ä¸ºæ­£å¼è·¯å¾„
            const imgMarkdown = `![${file.name}](data:image/png;base64,${base64Content})\n`;
            const start = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, start) + imgMarkdown + textarea.value.substring(textarea.selectionEnd);

            updatePreview(); // è§¦å‘ä¹‹å‰å®šä¹‰çš„å®æ—¶é¢„è§ˆå‡½æ•°
        };
        reader.readAsDataURL(file);
    }
    
    // ... å…¶ä½™ editPost, deletePost, resetForm é€»è¾‘ä¿æŒä¸å˜ ...
    // (çœç•¥éƒ¨åˆ†ä¸ä¹‹å‰ç›¸åŒä»¥ä¿æŒç®€æ´)

    function editPost(index) {
        const post = window.blogPosts[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('post-title').value = post.title;
        document.getElementById('post-category').value = post.category;
        document.getElementById('post-content').value = post.fullContent;
        document.getElementById('form-title').innerText = "ç¼–è¾‘æ–‡ç« ";
        window.scrollTo(0, document.body.scrollHeight);
    }
    // å®æ—¶æ›´æ–°é¢„è§ˆ
    function updatePreview() {
        const content = document.getElementById('post-content').value;
        const previewArea = document.getElementById('live-preview');

        // ä½¿ç”¨ä¸è¯¦æƒ…é¡µä¸€è‡´çš„é…ç½®æ¸²æŸ“
        marked.setOptions({ breaks: true, gfm: true });
        previewArea.innerHTML = marked.parse(content || "*ç­‰å¾…è¾“å…¥å†…å®¹...*");
    }

    // ä¼˜åŒ–çš„æ ¼å¼æ’å…¥å‡½æ•°
    function insertFormat(type, colorValue = null) {
        const textarea = document.getElementById('post-content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        let newText = "";

        switch (type) {
            case 'bold': newText = `**${selectedText || "ç²—ä½“"}**`; break;
            case 'italic': newText = `*${selectedText || "æ–œä½“"}*`; break;
            case 'color':
                newText = `<span style="color:${colorValue}">${selectedText || "å½©è‰²æ–‡å­—"}</span>`;
                break;
            case 'highlight': newText = `<mark>${selectedText || "å¼ºè°ƒ"}</mark>`; break;
            case 'image':
                const url = prompt("å›¾ç‰‡é“¾æ¥:");
                if(url) newText = `![æè¿°](${url})`;
                break;
        }

        const content = textarea.value;
        textarea.value = content.substring(0, start) + newText + content.substring(end);

        // æ’å…¥åç«‹å³æ›´æ–°é¢„è§ˆ
        updatePreview();

        textarea.focus();
        textarea.setSelectionRange(start + newText.length, start + newText.length);
    }

    // é¡µé¢åŠ è½½ååˆå§‹åŒ–ä¸€ä¸‹é¢„è§ˆ
    window.addEventListener('DOMContentLoaded', updatePreview);

    // ä¿®æ”¹ admin.html ä¸­çš„ savePost å‡½æ•°
    async function savePost() {
        // ... å‰ç½®æ ¡éªŒé€»è¾‘ ...

        btn.innerText = "ä¸Šä¼ å›¾ç‰‡ä¸­...";

        try {
            let content = document.getElementById('post-content').value;

            // 1. å…ˆä¸Šä¼ æ‰€æœ‰å›¾ç‰‡
            for (let img of pendingImages) {
                const imgPath = `images/${img.name}`;
                const success = await uploadFileToGitHub(imgPath, img.content, token);
                if (success) {
                    // ä¸Šä¼ æˆåŠŸåï¼Œå°†æ­£æ–‡é‡Œçš„ Base64 æ›¿æ¢ä¸ºçœŸå®çš„ GitHub å›¾ç‰‡è·¯å¾„
                    // è¿™æ · post.html è®¿é—®æ—¶å°±æ˜¯å¼•ç”¨ GitHub ä¸Šçš„å›¾ç‰‡äº†
                    const base64Pattern = `data:image/png;base64,${img.content}`;
                    content = content.replace(base64Pattern, imgPath);
                }
            }

            // 2. å‡†å¤‡æœ€ç»ˆçš„æ–‡ç« æ•°æ®
            const newPost = {
                title: document.getElementById('post-title').value,
                // ... å…¶ä»–å­—æ®µ ...
                fullContent: content // ä½¿ç”¨æ›¿æ¢è·¯å¾„åçš„å†…å®¹
            };

            // 3. åŒæ­¥ data.js
            const updatedPosts = [newPost, ...window.blogPosts];
            const syncSuccess = await syncToGitHub(updatedPosts, token);

            if (syncSuccess) {
                alert("å…¨éƒ¨åŒæ­¥æˆåŠŸï¼");
                pendingImages = []; // æ¸…ç©ºç¼“å­˜
                renderAdminList();
            }
        } catch (error) {
            console.error(error);
        } finally {
            btn.innerText = "ğŸš€ å‘å¸ƒå¹¶åŒæ­¥åˆ° GitHub";
            btn.disabled = false;
        }
    }

    // é€šç”¨çš„å•æ–‡ä»¶ä¸Šä¼ å‡½æ•°
    async function uploadFileToGitHub(path, base64Content, token) {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/${path}`;
        const res = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `Upload image: ${path}`,
                content: base64Content,
                branch: GITHUB_CONFIG.branch
            })
        });
        return res.ok;
    }

    // åŒæ­¥æ•°æ®åˆ° GitHub çš„æ ¸å¿ƒå‡½æ•°
    async function syncToGitHub(updatedPosts, token) {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;

        // 1. è·å–æœ€æ–° SHAï¼Œå¸¦ä¸Šæ—¶é—´æˆ³é˜²æ­¢è¯»å–ç¼“å­˜ SHA å¯¼è‡´å†²çª
        const getRes = await fetch(`${url}?ref=${GITHUB_CONFIG.branch}&t=${Date.now()}`, {
            headers: { "Authorization": `token ${token}` }
        });
        const fileData = await getRes.json();

        // 2. å‡†å¤‡æ–°å†…å®¹ï¼ˆä¿ç•™æ¢è¡Œç¬¦ \nï¼‰
        const newFileContent = `window.blogPosts = ${JSON.stringify(updatedPosts, null, 2)};`;

        // 3. PUT è¯·æ±‚æäº¤æ›´æ–°
        const putRes = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `Admin update: ${new Date().toLocaleString()}`,
                content: btoa(unescape(encodeURIComponent(newFileContent))), // å®Œç¾æ”¯æŒä¸­æ–‡
                sha: fileData.sha,
                branch: GITHUB_CONFIG.branch
            })
        });

        return putRes.ok;
    }

    // åˆ é™¤æ–‡ç« å‡½æ•°
    async function deletePost(index) {
        const token = document.getElementById('token-input').value;
        if(!token) return alert("è¯·è¾“å…¥ Token");

        if(confirm("ç¡®å®šåˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ")) {
            const posts = [...window.blogPosts];
            posts.splice(index, 1);

            const success = await syncToGitHub(posts, token);
            if(success) {
                alert("åˆ é™¤å¹¶åŒæ­¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                location.reload();
            } else {
                alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚");
            }
        }
    }

    function resetForm() {
        document.getElementById('edit-index').value = "-1";
        document.getElementById('post-title').value = "";
        document.getElementById('post-category').value = "";
        document.getElementById('post-content').value = "";
        document.getElementById('form-title').innerText = "æ’°å†™æ–°æ–‡ç« ";
    }
</script>
</body>
</html>