<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>极速后台 - MyNotes</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; }
        .post-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .edit-area { margin-top: 20px; border-top: 2px solid #2c3e50; pt: 20px; }
        input, textarea { width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        button.delete { background: #e74c3c; }
    </style>
</head>
<body>
<div class="admin-container">
    <h2>文章列表管理</h2>
    <div id="admin-post-list"></div>

    <div class="edit-area">
        <h3 id="form-title">新增文章</h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="text" id="post-title" placeholder="文章标题">
        <input type="text" id="post-category" placeholder="分类 (如: 技术, 生活)">
        <textarea id="post-content" rows="10" placeholder="支持内容文本..."></textarea>
        <button onclick="savePost()">发布并同步到 GitHub</button>
        <button onclick="resetForm()" style="background:#95a5a6">重置</button>
    </div>
</div>

<script src="data.js"></script>
<script src="githubService.js"></script>
<script>
    const listContainer = document.getElementById('admin-post-list');

    function renderAdminList() {
        listContainer.innerHTML = window.blogPosts.map((post, index) => `
                <div class="post-item">
                    <span>${post.title} (${post.date})</span>
                    <div>
                        <button onclick="editPost(${index})">编辑</button>
                        <button class="delete" onclick="deletePost(${index})">删除</button>
                    </div>
                </div>
            `).join('');
    }

    function editPost(index) {
        const post = window.blogPosts[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('post-title').value = post.title;
        document.getElementById('post-category').value = post.category;
        document.getElementById('post-content').value = post.fullContent;
        document.getElementById('form-title').innerText = "编辑文章";
    }

    async function savePost() {
        const index = parseInt(document.getElementById('edit-index').value);
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('post-content').value;
        const category = document.getElementById('post-category').value;

        const newPost = {
            title,
            date: new Date().toISOString().split('T')[0],
            excerpt: content.substring(0, 60).replace(/\n/g, "") + "...",
            fullContent: content,
            category
        };

        if (index === -1) {
            window.blogPosts.unshift(newPost); // 新增到开头
        } else {
            window.blogPosts[index] = newPost; // 修改
        }

        await syncToGitHub();
    }

    async function deletePost(index) {
        if (confirm("确定要删除吗？")) {
            window.blogPosts.splice(index, 1);
            await syncToGitHub();
        }
    }

    async function syncToGitHub() {
        const fileContent = `window.blogPosts = ${JSON.stringify(window.blogPosts, null, 2)};`;
        const ok = await updateGitHubData(fileContent);
        if (ok) {
            alert("同步成功！稍后刷新首页查看。");
            resetForm();
            renderAdminList();
        } else {
            alert("同步失败，请检查控制台报错。");
        }
    }

    function resetForm() {
        document.getElementById('edit-index').value = "-1";
        document.getElementById('post-title').value = "";
        document.getElementById('post-content').value = "";
        document.getElementById('form-title').innerText = "新增文章";
    }

    renderAdminList();
</script>
</body>
</html>