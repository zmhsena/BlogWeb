<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå° - Sena's blog</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }

        /* Token è¾“å…¥åŒºåŸŸæ ·å¼ */
        .token-section { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px dashed #cbd5e0; }
        .token-section h4 { margin-top: 0; color: #2d3748; }
        .token-input-group { display: flex; gap: 10px; align-items: center; }
        #token-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }

        .post-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .edit-area { margin-top: 30px; padding-top: 20px; border-top: 2px solid #2c3e50; }
        input, textarea { width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #2c3e50; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button.delete { background: #e74c3c; margin-left: 5px; }
        .status-msg { font-size: 0.9rem; margin-top: 10px; color: #3182ce; }
    </style>
</head>
<body>
<div class="admin-container">
    <h2>åšå®¢åå°ç®¡ç†</h2>

    <div class="token-section">
        <h4>ğŸ”‘ èº«ä»½éªŒè¯ (GitHub Token)</h4>
        <div class="token-input-group">
            <input type="password" id="token-input" placeholder="ghp_xxxxxxxxxxxx">
            <button onclick="saveTokenToLocal()" style="background: #4a5568;">ä¿å­˜åˆ°æœ¬åœ°</button>
            <button onclick="clearToken()" style="background: #a0aec0;">æ¸…é™¤</button>
        </div>
        <p style="font-size: 0.8rem; color: #718096; margin-top: 5px;">Token ä»…ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ è‡³ä»£ç åº“ã€‚</p>
    </div>

<!--    <div id="admin-post-list"></div>-->
    <div class="admin-main">
        <div class="list-section">
            <h3>å·²æœ‰æ–‡ç« åˆ—è¡¨</h3>
            <div id="admin-post-list" class="scroll-window">
            </div>
        </div>

        <div class="edit-section">
        </div>
    </div>

    <div class="edit-area">
        <h3 id="form-title">æ’°å†™æ–°æ–‡ç« </h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="text" id="post-title" placeholder="æ–‡ç« æ ‡é¢˜">
        <input type="text" id="post-category" placeholder="åˆ†ç±» (å¦‚: æŠ€æœ¯, ç”Ÿæ´»)">
        <textarea id="post-content" rows="12" placeholder="å†…å®¹æ”¯æŒ Markdown æ ¼å¼..."></textarea>
        <button id="submit-btn" onclick="savePost()">ğŸš€ å‘å¸ƒå¹¶åŒæ­¥åˆ° GitHub</button>
        <button onclick="resetForm()" style="background:#95a5a6">å–æ¶ˆä¿®æ”¹</button>
        <div id="status" class="status-msg"></div>
    </div>
</div>

<script src="data.js"></script>
<script src="githubService.js"></script>
<script>
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯»å–æœ¬åœ°ä¿å­˜çš„ Token
    window.onload = () => {
        const savedToken = localStorage.getItem('my_gh_token');
        if (savedToken) {
            document.getElementById('token-input').value = savedToken;
        }
        renderAdminList();
    };

    function saveTokenToLocal() {
        const val = document.getElementById('token-input').value;
        if (val) {
            localStorage.setItem('my_gh_token', val);
            alert('Token å·²åŠ å¯†ä¿å­˜è‡³æœ¬åœ°æµè§ˆå™¨å­˜å‚¨');
        }
    }

    function clearToken() {
        localStorage.removeItem('my_gh_token');
        document.getElementById('token-input').value = '';
        alert('æœ¬åœ° Token å·²æ¸…é™¤');
    }

    function renderAdminList() {
        const listContainer = document.getElementById('admin-post-list');
        const lastScrollPos = listContainer.scrollTop; // è®°å½•ä½ç½®
        listContainer.innerHTML = window.blogPosts.map((post, index) => `
                <div class="post-item">
                    <span><strong>${post.title}</strong> <small style="color: #666">(${post.date})</small></span>
                    <div>
                        <button onclick="editPost(${index})">ç¼–è¾‘</button>
                        <button class="delete" onclick="deletePost(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        listContainer.innerHTML = html;
        listContainer.scrollTop = lastScrollPos; // æ¢å¤ä½ç½®
    }

    // ... å…¶ä½™ editPost, deletePost, resetForm é€»è¾‘ä¿æŒä¸å˜ ...
    // (çœç•¥éƒ¨åˆ†ä¸ä¹‹å‰ç›¸åŒä»¥ä¿æŒç®€æ´)

    function editPost(index) {
        const post = window.blogPosts[index];
        document.getElementById('edit-index').value = index;
        document.getElementById('post-title').value = post.title;
        document.getElementById('post-category').value = post.category;
        document.getElementById('post-content').value = post.fullContent;
        document.getElementById('form-title').innerText = "ç¼–è¾‘æ–‡ç« ";
        window.scrollTo(0, document.body.scrollHeight);
    }

    async function savePost() {
        const btn = document.getElementById('submit-btn');
        const token = document.getElementById('token-input').value;

        if (!token) return alert("è¯·è¾“å…¥ Token");

        // 1. å˜æˆâ€œåŒæ­¥ä¸­â€çŠ¶æ€å¹¶ç¦ç”¨ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        const originalText = btn.innerText;
        btn.innerText = "åŒæ­¥ä¸­...";
        btn.disabled = true;

        try {
            const title = document.getElementById('post-title').value;
            const category = document.getElementById('post-category').value;
            const content = document.getElementById('post-content').value;

            if (!title || !content) {
                alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
                // æ³¨æ„ï¼šè¿™é‡Œä¹Ÿè¦æ¢å¤æŒ‰é’®ï¼Œå¦åˆ™ç‚¹å®Œè­¦å‘Šå°±ç‚¹ä¸äº†å‘å¸ƒäº†
                btn.innerText = originalText;
                btn.disabled = false;
                return;
            }

            const newPost = {
                title,
                category: category || "æœªåˆ†ç±»",
                date: new Date().toLocaleDateString(),
                excerpt: content.substring(0, 100) + "...",
                fullContent: content
            };

            // è¿™é‡Œçš„ window.blogPosts åº”è¯¥æ˜¯ä½  data.js åŠ è½½è¿›æ¥çš„æ•°ç»„
            const updatedPosts = [newPost, ...window.blogPosts];

            // 2. è°ƒç”¨åŒæ­¥å‡½æ•°
            const success = await syncToGitHub(updatedPosts, token);

            if (success) {
                alert("ä¸Šä¼ æˆåŠŸï¼");
                // æ¸…ç©ºè¾“å…¥æ¡†ä»¥ä¾¿è¿ç»­ä¸Šä¼ 
                document.getElementById('post-title').value = "";
                document.getElementById('post-content').value = "";

                // æ›´æ–°æœ¬åœ°å†…å­˜ä¸­çš„æ•°æ®ï¼Œè¿™æ ·ä¸‹æ¬¡åˆ é™¤æˆ–å†å¢åŠ å°±ä¸éœ€è¦åˆ·æ–°é¡µé¢
                window.blogPosts = updatedPosts;
                renderAdminList();
            } else {
                alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Token æƒé™");
            }

        } catch (error) {
            console.error("ä¿å­˜å‡ºé”™:", error);
            alert("å‘ç”Ÿé”™è¯¯: " + error.message);
        } finally {
            // 3. ã€å…³é”®ã€‘æ— è®º try å—æˆåŠŸè¿˜æ˜¯ catch å—æŠ¥é”™ï¼Œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œè¿™é‡Œ
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // åŒæ­¥æ•°æ®åˆ° GitHub çš„æ ¸å¿ƒå‡½æ•°
    async function syncToGitHub(updatedPosts, token) {
        const url = `https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.path}`;

        // 1. è·å–æœ€æ–° SHAï¼Œå¸¦ä¸Šæ—¶é—´æˆ³é˜²æ­¢è¯»å–ç¼“å­˜ SHA å¯¼è‡´å†²çª
        const getRes = await fetch(`${url}?ref=${CONFIG.branch}&t=${Date.now()}`, {
            headers: { "Authorization": `token ${token}` }
        });
        const fileData = await getRes.json();

        // 2. å‡†å¤‡æ–°å†…å®¹ï¼ˆä¿ç•™æ¢è¡Œç¬¦ \nï¼‰
        const newFileContent = `window.blogPosts = ${JSON.stringify(updatedPosts, null, 2)};`;

        // 3. PUT è¯·æ±‚æäº¤æ›´æ–°
        const putRes = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `Admin update: ${new Date().toLocaleString()}`,
                content: btoa(unescape(encodeURIComponent(newFileContent))), // å®Œç¾æ”¯æŒä¸­æ–‡
                sha: fileData.sha,
                branch: CONFIG.branch
            })
        });

        return putRes.ok;
    }

    // åˆ é™¤æ–‡ç« å‡½æ•°
    async function deletePost(index) {
        const token = document.getElementById('token-input').value;
        if(!token) return alert("è¯·è¾“å…¥ Token");

        if(confirm("ç¡®å®šåˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ")) {
            const posts = [...window.blogPosts];
            posts.splice(index, 1);

            const success = await syncToGitHub(posts, token);
            if(success) {
                alert("åˆ é™¤å¹¶åŒæ­¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                location.reload();
            } else {
                alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚");
            }
        }
    }

    function resetForm() {
        document.getElementById('edit-index').value = "-1";
        document.getElementById('post-title').value = "";
        document.getElementById('post-category').value = "";
        document.getElementById('post-content').value = "";
        document.getElementById('form-title').innerText = "æ’°å†™æ–°æ–‡ç« ";
    }
</script>
</body>
</html>